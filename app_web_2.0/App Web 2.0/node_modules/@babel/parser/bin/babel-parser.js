#!/usr/bin/env node
/* eslint-disable no-var, unicorn/prefer-node-protocol */

const path = require("path");
const fs = require("fs");
const parser = require("..");

const filename = process.argv[2];

if (!filename) {
  console.error("no filename specified");
  process.exit(1);
}

// Ruta segura base (donde deber√≠an estar tus archivos permitidos)
const safeBaseDir = path.resolve(__dirname, "../allowed"); // ajusta este path

// Normaliza y bloquea traversal
const targetPath = path.resolve(safeBaseDir, filename);

// Bloquea si intenta salirse del directorio seguro
if (!targetPath.startsWith(safeBaseDir)) {
  console.error("Blocked: attempted path traversal");
  process.exit(1);
}

try {
  const file = fs.readFileSync(targetPath, "utf8");
  const ast = parser.parse(file);
  console.log(JSON.stringify(ast, null, 2));
} catch (err) {
  console.error("Error reading/parsing file:", err.message);
  process.exit(1);
}
